name: Update AUR Package

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag/version to publish to AUR'
        required: true
        type: string

jobs:
  update-aur:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi

          # Strip path prefix (e.g. release/0.65-beta -> 0.65-beta) and leading 'v'
          TAG="${TAG##*/}"

          # Strip leading 'v' for package version and filename
          CLEAN_VERSION="${TAG#v}"

          # Sanitize version for pkgver (AUR doesn't allow hyphens)
          # Replace hyphens with underscores
          PKGVER="${CLEAN_VERSION//-/_}"

          # Determine if tag has 'v' prefix for URL construction in PKGBUILD
          if [[ "$TAG" == v* ]]; then
            TAG_PREFIX="v"
          else
            TAG_PREFIX=""
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT
          echo "pkgver=$PKGVER" >> $GITHUB_OUTPUT
          echo "tag_prefix=$TAG_PREFIX" >> $GITHUB_OUTPUT

          echo "Tag: $TAG"
          echo "Clean Version: $CLEAN_VERSION"
          echo "Package Version (pkgver): $PKGVER"

      - name: Wait for release assets
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.clean_version }}"
          # URL pattern: .../download/<VERSION>/hei-datahub-<VERSION>-linux-x86_64.AppImage
          APPIMAGE_URL="https://github.com/0xpix/Hei-DataHub/releases/download/${VERSION}/hei-datahub-${VERSION}-linux-x86_64.AppImage"

          echo "Waiting for AppImage to be available at:"
          echo "$APPIMAGE_URL"

          # Wait up to 10 minutes for the release asset
          for i in {1..60}; do
            if curl -sLI "$APPIMAGE_URL" | grep -q "200 OK\|HTTP/2 200"; then
              echo "AppImage is available!"
              exit 0
            fi
            echo "Attempt $i/60 - AppImage not yet available, waiting 10s..."
            sleep 10
          done

          echo "ERROR: AppImage not available after 10 minutes"
          exit 1

      - name: Download AppImage and compute checksum
        id: checksum
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.clean_version }}"
          # Using VERSION in URL to match the expected link format
          APPIMAGE_URL="https://github.com/0xpix/Hei-DataHub/releases/download/${VERSION}/hei-datahub-${VERSION}-linux-x86_64.AppImage"

          echo "Downloading AppImage..."
          curl -L -o "HeiDataHub.AppImage" "$APPIMAGE_URL"

          APPIMAGE_SHA256=$(sha256sum "HeiDataHub.AppImage" | cut -d' ' -f1)
          echo "appimage_sha256=$APPIMAGE_SHA256" >> $GITHUB_OUTPUT
          echo "AppImage SHA256: $APPIMAGE_SHA256"

          # Download icon and compute checksum
          curl -L -o "icon.png" "https://raw.githubusercontent.com/0xpix/Hei-DataHub/main/assets/png/icon_1024.png"
          ICON_SHA256=$(sha256sum "icon.png" | cut -d' ' -f1)
          echo "icon_sha256=$ICON_SHA256" >> $GITHUB_OUTPUT
          echo "Icon SHA256: $ICON_SHA256"

          # Download license and compute checksum
          curl -L -o "LICENSE" "https://raw.githubusercontent.com/0xpix/Hei-DataHub/main/LICENSE"
          LICENSE_SHA256=$(sha256sum "LICENSE" | cut -d' ' -f1)
          echo "license_sha256=$LICENSE_SHA256" >> $GITHUB_OUTPUT
          echo "License SHA256: $LICENSE_SHA256"

      - name: Compute desktop file checksum
        id: desktop_checksum
        run: |
          mkdir -p aur
          cp assets/linux/hei-datahub.desktop aur/hei-datahub.desktop
          DESKTOP_SHA256=$(sha256sum "aur/hei-datahub.desktop" | cut -d' ' -f1)
          echo "desktop_sha256=$DESKTOP_SHA256" >> $GITHUB_OUTPUT
          echo "Desktop SHA256: $DESKTOP_SHA256"

      - name: Generate updated PKGBUILD
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.clean_version }}"
          PKGVER="${{ steps.version.outputs.pkgver }}"
          TAG_PREFIX="${{ steps.version.outputs.tag_prefix }}"
          APPIMAGE_SHA256="${{ steps.checksum.outputs.appimage_sha256 }}"
          DESKTOP_SHA256="${{ steps.desktop_checksum.outputs.desktop_sha256 }}"
          ICON_SHA256="${{ steps.checksum.outputs.icon_sha256 }}"
          LICENSE_SHA256="${{ steps.checksum.outputs.license_sha256 }}"

          # Note: pkgver uses sanitized version (no hyphens), but download URLs use original VERSION
          cat > aur/PKGBUILD << EOF
          # Maintainer: Hei-DataHub <noreply@example.com>
          # AUR package for Hei-DataHub
          # Installs the AppImage system-wide with desktop integration

          pkgname=hei-datahub
          pkgver=${PKGVER}
          pkgrel=1
          pkgdesc="Lightweight local data hub with TUI for managing datasets"
          arch=('x86_64')
          url="https://github.com/0xpix/Hei-DataHub"
          license=('MIT')
          depends=('fuse2')
          options=('!strip')
          _realver=${VERSION}
          source=(
              "hei-datahub-\${_realver}-linux-x86_64.AppImage::https://github.com/0xpix/Hei-DataHub/releases/download/${TAG_PREFIX}\${_realver}/hei-datahub-\${_realver}-linux-x86_64.AppImage"
              "hei-datahub.desktop"
              "hei-datahub.png::https://raw.githubusercontent.com/0xpix/Hei-DataHub/main/assets/png/icon_1024.png"
              "LICENSE::https://raw.githubusercontent.com/0xpix/Hei-DataHub/main/LICENSE"
          )
          sha256sums=(
              '${APPIMAGE_SHA256}'
              '${DESKTOP_SHA256}'
              '${ICON_SHA256}'
              '${LICENSE_SHA256}'
          )

          package() {
              # Create directories
              install -dm755 "\${pkgdir}/opt/\${pkgname}"
              install -dm755 "\${pkgdir}/usr/bin"
              install -dm755 "\${pkgdir}/usr/share/applications"
              install -dm755 "\${pkgdir}/usr/share/icons/hicolor/256x256/apps"
              install -dm755 "\${pkgdir}/usr/share/licenses/\${pkgname}"

              # Install AppImage
              install -Dm755 "hei-datahub-\${_realver}-linux-x86_64.AppImage" "\${pkgdir}/opt/\${pkgname}/hei-datahub.AppImage"

              # Create wrapper script
              cat > "\${pkgdir}/usr/bin/\${pkgname}" << 'WRAPPER'
          #!/bin/bash
          # Wrapper script for Hei-DataHub AppImage
          exec /opt/hei-datahub/hei-datahub.AppImage "\$@"
          WRAPPER
              chmod 755 "\${pkgdir}/usr/bin/\${pkgname}"

              # Install desktop entry
              install -Dm644 "hei-datahub.desktop" "\${pkgdir}/usr/share/applications/hei-datahub.desktop"

              # Install icon
              install -Dm644 "hei-datahub.png" "\${pkgdir}/usr/share/icons/hicolor/256x256/apps/hei-datahub.png"

              # Install license
              install -Dm644 "\${srcdir}/LICENSE" "\${pkgdir}/usr/share/licenses/\${pkgname}/LICENSE"
          }
          EOF

          echo "Generated PKGBUILD:"
          cat aur/PKGBUILD

      - name: Validate PKGBUILD and generate .SRCINFO
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.clean_version }}"

          # Check for bare tokens (e.g. source=VERSION) - but allow _realver which is intentional
          if grep -q "source=.*[^_]VERSION" aur/PKGBUILD; then
             echo "::error::PKGBUILD contains invalid 'VERSION' in source array!"
             exit 1
          fi

          # Prepare files for validation (to avoid re-downloading)
          # We place the downloaded assets where makepkg expects them so makepkg -o verifies them
          # Note: Using VERSION (original) since _realver in PKGBUILD references the original version
          cp "HeiDataHub.AppImage" "aur/hei-datahub-${VERSION}-linux-x86_64.AppImage"
          cp "icon.png" "aur/hei-datahub.png"
          cp "LICENSE" "aur/LICENSE"

          # Prepare directory for docker ownership
          chmod 777 aur
          chmod 666 aur/*

          # Use a docker container to run makepkg
          echo "Running makepkg in container..."
          docker run --rm -v "$PWD/aur:/pkg" -w /pkg archlinux:base-devel /bin/bash -c "
            # Create a build user (makepkg cannot run as root)
            useradd builduser -m
            chown -R builduser /pkg

            # Generate .SRCINFO
            echo 'Generating .SRCINFO...'
            su builduser -c 'makepkg --printsrcinfo > .SRCINFO'

            # Verify packaging (checks integrity of existing files)
            echo 'Validating PKGBUILD...'
            su builduser -c 'makepkg -od'
          "

          echo "Generated .SRCINFO:"
          cat aur/.SRCINFO

          # Ensure .SRCINFO exists and not empty
          if [[ ! -s aur/.SRCINFO ]]; then
             echo "::error::.SRCINFO was not generated or empty!"
             exit 1
          fi

      - name: Upload packaging artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: aur-package-files
          path: |
            aur/PKGBUILD
            aur/.SRCINFO

      - name: Setup SSH for AUR
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [[ -z "$AUR_SSH_KEY" ]]; then
            echo "::error::AUR_SSH_KEY secret is not set!"
            echo "To enable AUR publishing:"
            echo "1. Generate SSH key: ssh-keygen -t ed25519 -f aur_key -N ''"
            echo "2. Add public key (aur_key.pub) to your AUR account at https://aur.archlinux.org/account"
            echo "3. Add private key (aur_key) as 'AUR_SSH_KEY' repository secret in GitHub"

            # Fail the job if this is a tag push (release)
            if [[ "${{ github.event_name }}" == "push" ]]; then
              exit 1
            fi

            echo "WARNING: Skipping AUR push (workflow_dispatch without key). PKGBUILD generated but not pushed."
            exit 0
          fi

          mkdir -p ~/.ssh
          echo "$AUR_SSH_KEY" > ~/.ssh/aur_key
          chmod 600 ~/.ssh/aur_key

          # Disable StrictHostKeyChecking to avoid interactive prompts
          cat >> ~/.ssh/config << EOF
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur_key
            User aur
            StrictHostKeyChecking no
          EOF

      - name: Clone AUR repo and push updates
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          if [[ -z "$AUR_SSH_KEY" ]]; then
            echo "Skipping AUR push (no SSH key configured)"
            exit 0
          fi

          VERSION="${{ steps.version.outputs.clean_version }}"

          # Clone AUR repo
          git clone ssh://aur@aur.archlinux.org/hei-datahub.git aur-repo || {
            echo "AUR repo doesn't exist yet. Create it first at:"
            echo "https://aur.archlinux.org/pkgbase/hei-datahub/submit/"
            exit 1
          }

          # Copy updated files
          cp aur/PKGBUILD aur-repo/
          cp aur/.SRCINFO aur-repo/
          cp aur/hei-datahub.desktop aur-repo/

          # Commit and push
          cd aur-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add -A
          git commit -m "Update to version ${VERSION}" || echo "No changes to commit"
          git push origin master

      - name: Summary
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.clean_version }}"
          echo "## AUR Package Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${VERSION} (Tag: ${TAG})" >> $GITHUB_STEP_SUMMARY
          echo "- **Package:** hei-datahub" >> $GITHUB_STEP_SUMMARY
          echo "- **AppImage SHA256:** ${{ steps.checksum.outputs.appimage_sha256 }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install on Arch Linux" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'yay -S hei-datahub' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
